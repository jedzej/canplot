import{j as B}from"./jsx-runtime-D_zvdyIk.js";import{R as g,r as k}from"./iframe-Csdz-dE8.js";import{d as w,e as v,g as O,u as N,c as G,a as U}from"./CanPlot-BTwvQezf.js";const C=()=>{const o=[];return{addEventListener:(r,s)=>(o.push({syncKey:r,callback:s}),()=>{const i=o.findIndex(d=>d.callback===s);i!==-1&&o.splice(i,1)}),dispatchEvent:(r,s)=>{for(const i of o)i.syncKey===r&&i.callback(r,s)}}},p={dblclick:C(),click:C(),move:C(),mousedown:C(),mouseup:C(),spanselect:C(),documentmouseup:C(),sync_dblclick:C(),sync_click:C(),sync_move:C(),sync_mousedown:C(),sync_mouseup:C(),sync_spanselect:C()},f=(o,r,s)=>{const i=g.useRef(s);i.current=s,g.useEffect(()=>p[o].addEventListener(r,(n,u)=>{i.current(u,n)}),[r,o,i])},z=g.createContext(""),se=(o,r)=>{const s=g.useContext(z);return f(o,s,r)},Q=(o,r,s,i,d)=>{if(!r)return;const n=i??s.scales.find(m=>m.origin==="x")?.id,u=d??s.scales.find(m=>m.origin==="y")?.id;if(!n||!u)return;const a=o.clientX-r.left,y={scaleId:n,value:v(s,a,n)},h=o.clientY-r.top,I={scaleId:u,value:v(s,h,u)};return{pointerSyncPosition:{x:y,y:I},cssX:a,cssY:h}},K=(o,r)=>{const s=o.x?w(r,o.x.value,o.x.scaleId,"css"):0,i=o.y?w(r,o.y.value,o.y.scaleId,"css"):0;return{cssX:s,cssY:i,scaled:Object.fromEntries(r.scales.map(d=>{const n=d.origin==="y"?i:s;return[d.id,v(r,n,d.id)]}))}},q=(o,r,s)=>{if(!r){const u=o==="x"?s.chartAreaCSS.x:s.chartAreaCSS.y,a=o==="x"?s.chartAreaCSS.x+s.chartAreaCSS.width:s.chartAreaCSS.y+s.chartAreaCSS.height;return{fromCSS:u,toCSS:a,scaled:s.scales.flatMap(y=>{if(y.origin!==o)return[];const{min:h,max:I}=O(s,y.id);return[{scaleId:y.id,from:h,to:I}]})}}const i=w(s,r.from,r.scaleId,"css"),d=w(s,r.to,r.scaleId,"css"),n=s.scales.flatMap(u=>{if(u.origin!==o)return[];const a=v(s,i,u.id),y=v(s,d,u.id);return[{scaleId:u.id,from:a,to:y}]});return{fromCSS:i,toCSS:d,scaled:n}},W=({id:o,onClick:r,onDblClick:s,onMouseMove:i,onMouseDown:d,onMouseUp:n,onDocumentMouseUp:u,onSpanSelect:a,className:y,style:h,sync:I,children:m})=>{const b=k.useId(),e=o||b;return f("dblclick",e,t=>{s?.(t)}),f("click",e,t=>{r?.(t)}),f("move",e,t=>{i?.(t)}),f("mousedown",e,t=>{d?.(t)}),f("mouseup",e,t=>{n?.(t)}),f("documentmouseup",e,t=>{u?.(t)}),f("spanselect",e,t=>{a?.(t)}),B.jsxs(z,{value:e,children:[B.jsx(Z,{className:y,style:h,sync:I}),m]})},Z=({className:o,style:r,sync:s})=>{const i=k.useRef(null),d=N(),n=k.useRef(d);n.current=d;const u=k.useContext(z),a=s?.key||u,y=k.useRef(null),h=k.useRef(null),I=()=>{const e=i.current?.parentElement;if(e){if(e.dataset.canplotroot===void 0)throw new Error("ChartAreaInteractions must be used within a CanPlot component");return e.getBoundingClientRect()}},m=(e,t)=>{const l=Q(e,I(),n.current,s?.xViaScaleId,s?.yViaScaleId);l&&t(l.pointerSyncPosition,{cssX:l.cssX,cssY:l.cssY},{ctrlKey:e.ctrlKey,altKey:e.altKey,shiftKey:e.shiftKey,metaKey:e.metaKey})},b=k.useRef(m);return b.current=m,k.useEffect(()=>{const e=c=>{p.documentmouseup.dispatchEvent(a,{frame:n.current,keys:{ctrlKey:c.ctrlKey,altKey:c.altKey,shiftKey:c.shiftKey,metaKey:c.metaKey}})},t=c=>{const S={ctrlKey:c.ctrlKey,altKey:c.altKey,shiftKey:c.shiftKey,metaKey:c.metaKey},_=h.current;if(_&&Object.entries(S).some(([E,A])=>_.keys[E]!==A)){c.stopPropagation(),c.preventDefault();const E={..._,keys:S};h.current=E,p.sync_spanselect.dispatchEvent(a,E)}},l=c=>{m(c,(S,{cssX:_,cssY:E},A)=>{const L=y.current;if(!L||!S.x||!S.y)return;const R=n.current,M=L.xRangeCss.start,P=_,X=L.yRangeCss.start,Y=E,j=O(R,S.x.scaleId),T=O(R,S.y.scaleId);y.current={xRangeCss:{start:M,end:P},yRangeCss:{start:X,end:Y}};let x="none";const V=Math.abs(X-Y),D=Math.abs(M-P);V<10&&D<10?x="none":V>30&&D>30?x="box":V>D?x="y":x="x";const H=x==="x"||x==="box"?{scaleId:j.id,from:v(R,G(n.current,M,"css"),j.id),to:v(R,G(n.current,P,"css"),j.id)}:void 0,J=x==="y"||x==="box"?{scaleId:T.id,from:v(R,U(n.current,X,"css"),T.id),to:v(R,U(n.current,Y,"css"),T.id)}:void 0,F={mode:x,xRange:H,yRange:J,completed:!1,keys:A};h.current=F,p.sync_spanselect.dispatchEvent(a,F)})};return document.addEventListener("mouseup",e),document.addEventListener("keydown",t),document.addEventListener("keyup",t),document.addEventListener("mousemove",l),()=>{document.removeEventListener("mouseup",e),document.removeEventListener("keydown",t),document.removeEventListener("keyup",t),document.removeEventListener("mousemove",l)}},[n,a]),f("sync_dblclick",a,e=>{const t=K(e.positions,n.current);t&&p.dblclick.dispatchEvent(u,{frame:n.current,pointer:t,keys:e.keys})}),f("sync_click",a,e=>{const t=K(e.positions,n.current);t&&p.click.dispatchEvent(u,{frame:n.current,pointer:t,keys:e.keys})}),f("sync_move",a,e=>{const t=e.positions?K(e.positions,n.current):null;p.move.dispatchEvent(u,{frame:n.current,pointer:t??null,keys:e.keys})}),f("sync_mousedown",a,e=>{const t=K(e.positions,n.current);t&&p.mousedown.dispatchEvent(u,{frame:n.current,pointer:t,keys:e.keys})}),f("sync_mouseup",a,e=>{const t=K(e.positions,n.current);t&&p.mouseup.dispatchEvent(u,{frame:n.current,pointer:t,keys:e.keys})}),f("sync_spanselect",a,e=>{const t=q("x",e.xRange,n.current),l=q("y",e.yRange,n.current),c=t.scaled,S=l.scaled;e.completed&&(y.current=null),p.spanselect.dispatchEvent(u,{mode:e.mode,frame:n.current,xRanges:c,yRanges:S,completed:e.completed,x:{fromCSS:t.fromCSS,toCSS:t.toCSS},y:{fromCSS:l.fromCSS,toCSS:l.toCSS},keys:e.keys})}),B.jsx("div",{ref:i,id:"interactions",className:o,style:{position:"absolute",left:d.chartAreaCSS.x,top:d.chartAreaCSS.y,width:d.chartAreaCSS.width,height:d.chartAreaCSS.height,zIndex:25,cursor:"none",...r},onClick:e=>{m(e,(t,l,c)=>{p.sync_click.dispatchEvent(a,{positions:t,keys:c})})},onMouseLeave:e=>{m(e,(t,l,c)=>{p.sync_move.dispatchEvent(a,{positions:null,keys:c})})},onMouseMove:e=>{m(e,(t,l,c)=>{p.sync_move.dispatchEvent(a,{positions:t,keys:c})})},onMouseDown:e=>{m(e,(t,{cssX:l,cssY:c},S)=>{p.sync_mousedown.dispatchEvent(a,{positions:t,keys:S}),h.current=null,y.current={xRangeCss:{start:l,end:l},yRangeCss:{start:c,end:c}}})},onMouseUp:e=>{m(e,(t,l,c)=>{p.sync_mouseup.dispatchEvent(a,{positions:t,keys:c});const S=h.current;h.current=null;const _=y.current;if(y.current=null,_&&S){const E={...S,keys:c,completed:!0};p.sync_spanselect.dispatchEvent(a,E)}})},onDoubleClick:e=>{m(e,(t,l,c)=>{p.sync_dblclick.dispatchEvent(a,{positions:t,keys:c})})}})};W.__docgenInfo={description:"",methods:[],displayName:"ChartAreaInteractions"};export{W as C,se as u};
